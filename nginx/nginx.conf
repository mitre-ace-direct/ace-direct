# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/
#   

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

# Load dynamic modules. See /usr/share/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

events {
  worker_connections 1024;
}

http {
  log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

  proxy_hide_header X-Powered-By; # remove sensitive field
  server_tokens off; # remove sensitive field

  access_log  /var/log/nginx/access.log  main;

  sendfile            on;
  tcp_nopush          on;
  tcp_nodelay         on;
  keepalive_timeout   10;
  types_hash_max_size 2048;
  client_max_body_size     1G;

  include             /etc/nginx/mime.types;
  default_type        application/octet-stream;

  # Load modular configuration files from the /etc/nginx/conf.d directory.
  # See http://nginx.org/en/docs/ngx_core_module.html#include
  # for more information.
  include /etc/nginx/conf.d/*.conf;

  # SERVER 1 block
  server {
    listen  80 default_server;
    return 301 https://$host$request_uri;
  }
  
  # SERVER 2 block
  server {
    listen       443 ssl;

    # Enable TLS 1.3
    ssl_protocols TLSv1.2;
    ssl_prefer_server_ciphers off;

    # Specify the location of the cert and key
    ssl_certificate /etc/ssl/cert.pem;
    ssl_certificate_key /etc/ssl/key.pem;

    server_tokens off; # remove sensitive field
    proxy_pass_header Server; # remove sensitive field

    server_name  _/;
    root         /usr/share/nginx/html;

    # HSTS header
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;

    #Added to secure NGINX from Clickjacking attack 
    add_header X-Frame-Options 'SAMEORIGIN';

    #Added to secure NGINX from sniffing content types 
    add_header X-Content-Type-Options 'nosniff';

    #Added to prevent cross-site scripting 
    add_header X-Xss-Protection '1; mode=block';

    # The Content-Security-Policy header allows you to restrict how resources such as JavaScript, CSS, or
    # pretty much anything that the browser loads.
    add_header Content-Security-Policy "default-src 'self';script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://unpkg.com/detect-gpu@4.0.35/dist/detect-gpu.esm.js ;  style-src 'self' 'unsafe-inline' https://maxcdn.bootstrapcdn.com https://fonts.googleapis.com https://use.fontawesome.com https://stackpath.bootstrapcdn.com  ;font-src 'self' https://maxcdn.bootstrapcdn.com  https://fonts.gstatic.com https://use.fontawesome.com;img-src 'self' data:; connect-src 'self' http://127.0.0.1:6298/setbusylight;";

    # Load configuration files for the default server block.
    include /etc/nginx/default.d/*.conf;

    error_page 500 502 503 504 /html/error50.html;
    error_page 400 403 404 /html/error40.html;
    proxy_intercept_errors on;

    location /html/ {
      root /etc/nginx;
      internal;
    }
    location = /error40.css {
      root /etc/nginx/html;
    }
    location = /error50.css {
      root /etc/nginx/html;
    }
    location = /ace.png {
      root /etc/nginx/images;
    }
    location = /acedirectsmall.png {
      root /etc/nginx/images;
    }
    location = /favicon.ico {
      root /etc/nginx/images;
    }

    location / {
      return 301 /ACEDirect;
    }

    # ace direct
    location /ACEDirect/ {
      proxy_pass https://<ACE_DIRECT_FQDN>:9001/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;
              
      sub_filter_once off;  
      sub_filter /node /;
      sub_filter 'href="/' 'href="/ACEDirect/';
      sub_filter "href='/" "href='/ACEDirect/";
      sub_filter 'src="/' 'src="/ACEDirect/';
      sub_filter "src='/" "src='/ACEDirect/";

      proxy_redirect https://<ACE_DIRECT_FQDN>:9001/ACEDirect/ /ACEDirect/;
    }

    # management portal
    location /ManagementPortal/ {
      proxy_pass https://<ACE_DIRECT_FQDN>:9002/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;

      sub_filter_once off;
      sub_filter /node /;

      proxy_redirect https://<ACE_DIRECT_FQDN>:9002/ManagementPortal/ /ManagementPortal/;
    }

    # fognito
    location /ace/ {
      proxy_pass https://<ACE_DIRECT_FQDN>:9003/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;

      sub_filter_once off;
      sub_filter /node /;

      sub_filter 'href="/' 'href="/ace/';
      sub_filter "href='/" "href='/ace/";
      sub_filter 'src="/' 'src="/ace/';
      sub_filter "src='/" "src='/ace/";

      proxy_redirect https://<ACE_DIRECT_FQDN>:9003/ace/ /ace/;
    }

    # sswebserver
    location /acedirect-kurento/ {
      proxy_pass https://<ACE_DIRECT_FQDN>:9004/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;
      proxy_read_timeout 99999s;

      sub_filter_types *; #application/javascript application/x-javascript;

      sub_filter_once off;
      sub_filter /node /;
      sub_filter "'wss://' + window.location.host" "'wss://' + window.location.host + '/acedirect-kurento'";

      proxy_redirect https://<ACE_DIRECT_FQDN>:9004/acedirect-kurento/ /acedirect-kurento/;
    }

  } # END SERVER 2 block

} # END http